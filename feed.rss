<?xml version="1.0" encoding="UTF-8"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content"><channel><title>An Unheralded Perspective</title><description>My thoughts on Swift, iOS development and beyond</description><link>https://siddarthkalra.github.io</link><language>en</language><lastBuildDate>Tue, 29 Dec 2020 15:35:57 -0500</lastBuildDate><pubDate>Tue, 29 Dec 2020 15:35:57 -0500</pubDate><ttl>250</ttl><atom:link href="https://siddarthkalra.github.io/feed.rss" rel="self" type="application/rss+xml"/><item><guid isPermaLink="true">https://siddarthkalra.github.io/articles/github-pages-custom-404-using-sundell-publish</guid><title>Custom 404 page for GitHub Pages</title><description>Easily add a custom 404 page when using John Sundell's Publish + GitHub Pages by using a custom publishing step.</description><link>https://siddarthkalra.github.io/articles/github-pages-custom-404-using-sundell-publish</link><pubDate>Sat, 26 Dec 2020 00:00:00 -0500</pubDate><content:encoded><![CDATA[<p>In a my <a href="https://siddarthkalra.github.io/articles/2020-12-20-migrated-to-publish/">previous article</a> about migrating this website to John Sundell's <a href="https://github.com/JohnSundell/Publish">Publish framework</a>, I mentioned that one of the issues I faced was around how a custom 404 page produced by Publish does not work for websites hosted by <a href="https://pages.github.com/">Github Pages</a>.</p><p>A page called 404.md will be placed under the following URL when using the <code>.foldersAndIndexFiles</code> case of the <code>HTMLFileMode</code> enum defined in Publish:</p><pre><code class="language-no-highlight">siddarthkalra.github.io/404/index.html
</code></pre><p>However, GitHub Pages expects:</p><pre><code class="language-no-highlight">siddarthkalra.github.io/404.html
</code></pre><p>Now, one way to fix this problem would be to simply switch the file mode to <code>.standAloneFiles</code> , which I could have done. However, I didn't want to change the file hierarchy for my entire website just for this one case.</p><p>I fixed my problem by adding a new publishing step that renames 404/index.html to 404/404.html, copies 404.html to the output folder and deletes the 404 folder. Here's the code:</p><pre><code><span class="splash-keyword">extension</span> <span class="splash-type">PublishingStep</span> {
    <span class="splash-keyword">static func</span> move404FileForGitHubPages() -&gt; <span class="splash-type">Self</span> {
        <span class="splash-keyword">let</span> stepName = <span class="splash-string">"Move 404 file for GitHub Pages"</span>

        <span class="splash-keyword">return</span> <span class="splash-call">step</span>(named: stepName) { context <span class="splash-keyword">in
            guard let</span> orig404Page = context.<span class="splash-property">pages</span>[<span class="splash-string">"404"</span>] <span class="splash-keyword">else</span> {
                <span class="splash-keyword">throw</span> <span class="splash-type">PublishingError</span>(stepName: stepName,
                                      infoMessage: <span class="splash-string">"Unable to find 404 page"</span>)
            }

            <span class="splash-keyword">let</span> orig404File = <span class="splash-keyword">try</span> context.<span class="splash-call">outputFile</span>(at: <span class="splash-string">"</span>\(orig404Page.<span class="splash-property">path</span>)<span class="splash-string">/index.html"</span>)
            <span class="splash-keyword">try</span> orig404File.<span class="splash-call">rename</span>(to: <span class="splash-string">"404"</span>)

            <span class="splash-keyword">guard
                let</span> orig404Folder = orig404File.<span class="splash-property">parent</span>,
                <span class="splash-keyword">let</span> outputFolder = orig404Folder.<span class="splash-property">parent</span>,
                <span class="splash-keyword">let</span> rootFolder = outputFolder.<span class="splash-property">parent</span>
            <span class="splash-keyword">else</span> {
                <span class="splash-keyword">throw</span> <span class="splash-type">PublishingError</span>(stepName: stepName,
                                      infoMessage: <span class="splash-string">"Unable find root, output and 404 folders"</span>)
            }

            <span class="splash-keyword">try</span> context.<span class="splash-call">copyFileToOutput</span>(from: <span class="splash-string">"</span>\(orig404File.<span class="splash-call">path</span>(relativeTo: rootFolder))<span class="splash-string">"</span>)
            <span class="splash-keyword">try</span> orig404Folder.<span class="splash-call">delete</span>()
        }
    }
}
</code></pre><p>Make sure to place this publishing step after the HTML generation step. To do so, you will need to adopt a custom publishing pipeline instead of the default one.</p>]]></content:encoded></item><item><guid isPermaLink="true">https://siddarthkalra.github.io/articles/2020-12-20-migrated-to-publish</guid><title>Migrated to Publish</title><description>Documenting learnings and future enhancements after migrating this website to Publish, a static site generator by John Sundell written in Swift!</description><link>https://siddarthkalra.github.io/articles/2020-12-20-migrated-to-publish</link><pubDate>Sun, 20 Dec 2020 00:00:00 -0500</pubDate><content:encoded><![CDATA[<h1>Migrated to Publish</h1><p>Today, I'm so glad to share that this website has been migrated to <a href="https://github.com/JohnSundell/Publish">Publish</a>, a static site generator by John Sundell written in Swift! ðŸŽ‰</p><p>I love working in <a href="https://swift.org/">Swift</a> so this was a no-brainer for me and for many others it seems. This website is hosted on <a href="https://pages.github.com/">GitHub Pages</a> and previously you were almost forced to adopt something like <a href="https://jekyllrb.com/">Jekyll</a>, a static site generator written in Ruby. Well, those days are over! I want to take this opportunity to document some learnings and future enhancements.</p><h2>Getting setup</h2><p>So how easy was it to migrate this incredibly small website to Publish?</p><p>If you have previous Swift knowledge, this will be a breeze to setup. John Sundell really deserves a ton of credit here for designing such a simple yet extensible API.</p><p>So lets go through the minimum amount of steps you need to complete in order to generate your fancy new website.</p><h3>1. Define your fancy new website</h3><p>This is done by conforming to the <code>Website</code> protocol.</p><pre><code><span class="splash-keyword">struct</span> FancyNewSite: <span class="splash-type">Website</span> {
    <span class="splash-keyword">enum</span> SectionID: <span class="splash-type">String</span>, <span class="splash-type">WebsiteSectionID</span> {
        <span class="splash-comment">// Add the sections that you want your website to contain here:</span>
        <span class="splash-keyword">case</span> posts
        <span class="splash-keyword">case</span> about
    }

    <span class="splash-keyword">struct</span> ItemMetadata: <span class="splash-type">WebsiteItemMetadata</span> {
        <span class="splash-comment">// Add any site-specific metadata that you want to use here.</span>
    }

    <span class="splash-comment">// Update these properties to configure your website:</span>
    <span class="splash-keyword">var</span> url = <span class="splash-type">URL</span>(string: <span class="splash-string">"https://fancynewsite.github.io"</span>)!
    <span class="splash-keyword">var</span> name = <span class="splash-string">"A Fancy New Site"</span>
    <span class="splash-keyword">var</span> description = <span class="splash-string">"Let's get fancy, shall we?"</span>
    <span class="splash-keyword">var</span> language: <span class="splash-type">Language</span> { .<span class="splash-dotAccess">english</span> }
    <span class="splash-keyword">var</span> imagePath: <span class="splash-type">Path</span>? { <span class="splash-keyword">nil</span> }
}
</code></pre><h3>2. Create a fancy theme</h3><p>This is how your website's HTML and CSS will be generated.</p><pre><code><span class="splash-keyword">extension</span> <span class="splash-type">Theme</span> <span class="splash-keyword">where</span> <span class="splash-type">Site</span> == <span class="splash-type">FancyNewSite</span> {
    <span class="splash-keyword">static var</span> fancyTheme <span class="splash-type">Self</span> {
        <span class="splash-type">Theme</span>(htmlFactory: <span class="splash-type">FancyHTMLFactory</span>(), resourcePaths: [<span class="splash-string">"Resources/fancyTheme/styles.css"</span>])
    }
}
</code></pre><p><code>FancyHTMLFactory</code> conforms to the <code>HTMLFactory</code> protocol. This is the type that will generate your website's HTML. Implement all the required methods and your site will be up and running in no time. Publish includes a default <code>foundation</code> theme that you can use as a reference.</p><h3>3. Define your fancy publishing pipeline</h3><p>There's two ways you can go here. We can get all fancy (pun intended) and use a custom pipeline or go with the default one that is provided out-of-the-box. I went with the default one for now since that has the advantage of being much quicker to setup.</p><pre><code><span class="splash-comment">// a default pipeline that generates your fancy site and deploys it to GitHub Pages</span>
<span class="splash-keyword">try</span> <span class="splash-type">FancyNewSite</span>().<span class="splash-call">publish</span>(withTheme: .<span class="splash-dotAccess">fancyTheme</span>,
                          deployedUsing: .<span class="splash-call">gitHub</span>(<span class="splash-string">"fancyNewSite/fancynewsite.github.io"</span>, useSSH: <span class="splash-keyword">true</span>))
</code></pre><h3>4. Run locally then deploy</h3><p>Publish comes with a command line tool which provides the ability to run your website locally. Just execute the following in your terminal: <code>publish run -p 8000</code>.</p><p>Once you've iterated on your website locally it's time to share your hard work with the outside world. Again this is extremely simple - just run <code>publish deploy</code>.</p><p>That's it! You now have the excuse to get all fancy! ðŸ˜…</p><img src="https://media.giphy.com/media/c0BgDP4p4gO8E/giphy.gif" alt="Fancy GIF"/><h2>Issues encountered</h2><p>Alright putting all the fanciness aside, let's talk about some of the issues I encountered along the way.</p><h3>Local HTTP server blocks ports</h3><p>Every now and again the HTTP server can develop a glitch and stop working. You'll get a message indicating the port you're trying to use is already taken. Not sure how this ends up happening but it can get a bit annoying as you're forced to choose a different port each time. Since the server used by Publish is written in Python, I tried killing any Python process that was running on my machine but unfortunately that didn't remedy the problem.</p><p>However, really the problem was just with my original workflow. Every time I would regenerate my site, I would just restart the server thus increasing the likelihood of running into this problem. A better approach is to keep the HTTP server running and just use another shell to execute <code>publish generate</code> to regenerate your website without having to constantly restart your server.</p><h3>Swift Package Manager</h3><p>Publish is just a <a href="https://swift.org/package-manager/">Swift package</a> and so is the website project that gets generated after you run <code>publish new</code>. I have experience with other dependency managers like <a href="https://github.com/Carthage/Carthage">Carthage</a>, <a href="https://cocoapods.org/">CocoaPods</a> and even <a href="https://www.npmjs.com/">NPM</a> but I'm pretty new to Swift Package Manager (SPM).</p><p>In order to add Swift syntax highlighting to my posts, I decided to adopt Sundell's <a href="https://github.com/JohnSundell/SplashPublishPlugin">Publish plugin for Splash</a>. However, adding <code>SplashPublishPlugin</code> as a dependency in my website's Package.swift, broke my build. I couldn't generate my website anymore as Xcode would no longer detect that my website had any active targets.</p><img src="https://media.giphy.com/media/3oKIPsU8OC7JhkvY8U/giphy.gif" alt="I'm stuck GIF"/><p>I was stumped. I had no idea how Xcode got into this state. So, I went for a swim in the world of SPM by reading Apple's <a href="https://swift.org/package-manager/">official docs</a> and even Sundell's <a href="https://www.swiftbysundell.com/articles/managing-dependencies-using-the-swift-package-manager/">article</a> on the subject. An hour went by but I couldn't solve the problem.</p><p>My intuition indicated that I somehow needed to reset my build and throw out any existing build artifacts to have a "fresh start". I just didn't know how though. Ultimately, spending a bit of time snooping around Xcode revealed the solution.</p><pre><code class="language-no-highlight">File Ëƒ Swift Packages Ëƒ Reset Package Caches
</code></pre><p>This forces Xcode to regenerate your entire package dependency chain. Once I chose this option all my problems were solved and I could generate my website once again. I was back on track.</p><h3>Section vs. Page</h3><p><code>Section</code> essentially models a directory with a rigid hierarchy. <code>Item</code> models each page within this directory and a given <code>Section</code> can contain many items.</p><p><code>Page</code>, on the other hand, models a standalone HTML page and doesn't hold any pre-conceived notions around directory hierarchy.</p><p>Use <code>Section</code> when you want to group a set of pages together. If something is standalone then use <code>Page</code> instead.</p><h3>WebsiteItemMetadata</h3><p><code>WebsiteItemMetadata</code> is a protocol that basically gives you the ability to include custom metadata for each <code>Item</code> defined by your website. Publish takes advantage of Swift's type system and allows us to work with a strongly typed struct instead of using something like a dictionary, which cannot provide the same compile-time guarantees.</p><p>Let's go through an example to solidify our understanding. Say I want to add a timestamp that indicates the last time each post on my website was edited. Posts on my website are embedded within a <code>Section</code> called <code>posts</code> and thus each post is an <code>Item</code>.</p><p>All I have to do now is to add the following to my metadata struct:</p><pre><code><span class="splash-keyword">struct</span> ItemMetadata: <span class="splash-type">WebsiteItemMetadata</span> {
    <span class="splash-keyword">var</span> lastEdited: <span class="splash-type">Date</span>
}
</code></pre><p>Now I can go through each one of my posts written in markdown and add this information within the --- lines at the top.</p><pre><code class="language-no-highlight">---
lastEdited: 2020-10-21 16:49
---
</code></pre><p>Lastly, I can simply access this new property in Swift via <code>item.lastEdited</code>. If somehow you don't update each post, Publish will throw an error when the site is regenerated:</p><pre><code class="language-no-highlight">Fatal error: Error raised at top level: Publish encountered an error:
[step] Add Markdown files from 'Content' folder
[path] posts/fancy-new-post.md
[info] Missing metadata value for key 'lastEdited'
</code></pre><p>Consider a website with hundred of posts. It would be easy to make mistakes and miss updating a post here or there. This type of rigid enforcement at generation time prevents such mistakes and doesn't let you move forward with publishing until you fix them. I think that's incredibly useful.</p><h3>Diffing the generated HTML</h3><p>The really nice part of Publish is that, if you commit your Output directory to Git, you can track exactly how your website's HTML has changed every time you regenerate it. This is a really nice way to catch regressions. The only issue is that the generated HTML is minified so understanding the diff becomes next to impossible.</p><p>If only there was a way to prevent this minification while you're developing? ðŸ¤” Maybe there is but I haven't found it yet. I'll keep digging and report back if I find something!</p><h3>Deploying to GitHub Pages</h3><p>GitHub pages expects the content of your website to be situated in the root directory of your repository. However, by default, Publish will situate your generated website in <code>Output/</code>. Brian Coyner's <a href="https://briancoyner.github.io/articles/2020-02-25-cocoaheads_publish_notes/">article</a> on Publish came up with a great solution that I've adopted. The gist of the solution is as follows:</p><ul><li>Create a new branch called <code>author</code> or whatever suits your fancy</li><li>Push this branch to remote and make this your base branch on GitHub so that all new PRs are opened against this branch by default</li><li><code>author</code> becomes your main branch where the code for your Publish website package lives</li><li><code>master</code> becomes your deployment branch which only holds the generated HTML &amp; CSS for your website</li><li>Instead of changing <code>master</code> directly, deploy new changes to <code>master</code> by using <code>publish deploy</code> (assuming that your publishing pipeline is already setup to deploy to GitHub)</li></ul><h2>Future enhancements</h2><p>Getting the initial version of my website up and running has been so much fun! However, there's at least a couple more things I have in mind that would really streamline my process:</p><ul><li>for every new post, add the ability to automatically cross-publish the post on Medium and submit a tweet</li><li>add the ability to work on drafts without publishing them to the website before they're ready</li><li>a custom 404 page</li><li>support for multiple CSS files that get minified into one CSS file</li></ul><p>As I make progress on these enhancements, I hope to share updates. Thank you to all that stuck around till the end. All feedback is welcome, so please don't hesitate to reach out to me on <a href="https://twitter.com/siddarthkalra">Twitter</a>. Now let's go build some websites! ðŸš€</p>]]></content:encoded></item><item><guid isPermaLink="true">https://siddarthkalra.github.io/articles/2019-04-19-uncaught-exceptions-macos</guid><title>Uncaught exceptions on macOS</title><description>I recently came across a peculiar distinction between how exceptions manifest on macOS vs. iOS. On iOS, if an NSRangeException (index out of bounds) occurs, your app will crash, no questions asked. However, that is not always the case on macOS</description><link>https://siddarthkalra.github.io/articles/2019-04-19-uncaught-exceptions-macos</link><pubDate>Fri, 19 Apr 2019 18:45:00 -0400</pubDate><content:encoded><![CDATA[<h1>Uncaught exceptions on macOS</h1><p>I recently came across a peculiar distinction between how exceptions manifest on macOS vs. iOS.</p><p>On iOS, if an <code>NSRangeException</code> (index out of bounds) occurs, your app will crash, no questions asked. However, that is not always the case on macOS. This behaviour doesn't seem to be that widely known and I had to go digging quite a bit to uncover its roots.</p><p>On macOS, exceptions that go unhandled will rise to the level of the uncaught exception handler. This is the point where one can perform extra logic before the program exits. The default handler logs the exception to the console before exiting.</p><p>However, the key point is that exceptions on the main thread don't rise to the level of the uncaught exception handler as the global application object catches them preemptively. This is why certain exceptions don't lead to a crash on macOS. Apple details this behaviour <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Exceptions/Concepts/UncaughtExceptions.html">here</a>.</p><p>If your app is using a crash reporting tool like <a href="https://Sentry.io">Sentry</a> or <a href="https://firebase.google.com/docs/crashlytics/">Crashlytics</a>, you don't want to silently log exceptions to the console. You want to know about them. So, how do we handle these exceptions?</p><p>We can subclass <code>NSApplication</code> and override the <code>reportException(_:)</code> method to provide our own custom behaviour:</p><pre><code><span class="splash-keyword">@objc</span>(<span class="splash-type">CustomExceptionHandlingApp</span>)
<span class="splash-keyword">class</span> CustomExceptionHandlingApp: <span class="splash-type">NSApplication</span> {

    <span class="splash-keyword">override func</span> reportException(<span class="splash-keyword">_</span> exception: <span class="splash-type">NSException</span>) {
        <span class="splash-type">UserDefaults</span>.<span class="splash-property">standard</span>.<span class="splash-call">register</span>(defaults: [<span class="splash-string">"NSApplicationCrashOnExceptions"</span>: <span class="splash-keyword">true</span>])

        <span class="splash-comment">// custom code to handle the exception here</span>

        <span class="splash-keyword">super</span>.<span class="splash-call">reportException</span>(exception)
    }

}
</code></pre><p>After creating the subclass, make sure to update the <code>NSPrincipalClass</code> key in your app's Info.plist to the name of the subclass instead of <code>NSApplication</code>.</p><p>The last thing to note is that if you want your application to exit when an exception occurs then set the <code>NSApplicationCrashOnExceptions</code> key to <code>true</code>.</p>]]></content:encoded></item><item><guid isPermaLink="true">https://siddarthkalra.github.io/articles/2019-04-06-side-effects</guid><title>Side effects</title><description>Side effects can have deadly consequences. We all pay attention to them when picking up a pack of antibiotics from the pharmacist. But are you paying attention to them when writing your next app feature?</description><link>https://siddarthkalra.github.io/articles/2019-04-06-side-effects</link><pubDate>Sat, 6 Apr 2019 18:45:00 -0400</pubDate><content:encoded><![CDATA[<h1>Side effects</h1><p>Side effects can have deadly consequences. We all pay attention to them when picking up a pack of antibiotics from the pharmacist. But are you paying attention to them when writing your next app feature? If you haven't been, I'm here to convince you that it's worth reading the fine-print and avoiding them whenever possible.</p><img src="https://siddarthkalra.github.io/images/side-effects.jpg" alt="Side Effects meme"/><p>So, let's start by defining our terms. Side effects, in the realm of programming, are hidden consequences or changes. That is, when calling a function leads to something being accessed or changed outside the scope of that function. The function can then no longer be considered <a href="https://en.wikipedia.org/wiki/Pure_function">pure</a>. Here is an example of a pure function:</p><pre><code><span class="splash-keyword">func</span> multiplyBy2(<span class="splash-keyword">_</span> value: <span class="splash-type">Int</span>) -&gt; <span class="splash-type">Int</span> {
    <span class="splash-keyword">return</span> value * <span class="splash-number">2</span>
}
</code></pre><p>We usually want to aim for pure functions whenever possible because they allow us to locally reason about our program as there is no global impact upon invocation. Introducing side effects means that we may no longer be able to reason locally as changes at the global scope can be introduced. This increases the complexity of our program.</p><p>Today we're going to discuss two types of side effects: <strong>hidden inputs</strong> and <strong>hidden outputs</strong>. As a general rule, hidden changes are something that you want to avoid. Having implicit changes can make your API unclear and unobvious, which can lead to misuse and unintended results. Now that we've covered what side effects are, let's examine each flavor in detail.</p><p>Say, I'm writing a chat messaging app to break the dominance of WhatsApp in the market. That's going to be tough, so let's ensure that our basics are right first. To do this, I need a way to represent messages in my program. We'll start by defining a data structure that describes the main building block of the app:</p><pre><code><span class="splash-keyword">struct</span> ChatMessage {
    <span class="splash-keyword">let</span> userName: <span class="splash-type">String</span>
    <span class="splash-keyword">let</span> message: <span class="splash-type">String</span>
    <span class="splash-keyword">let</span> creationDate: <span class="splash-type">Date</span>
}
</code></pre><p>Now, I might want to display the chat messages a given user has sent over the last day. For that, I could write a function like so:</p><pre><code><span class="splash-keyword">func</span> getLastDaysChatMessages() -&gt; [<span class="splash-type">ChatMessage</span>]? {
  <span class="splash-keyword">guard let</span> rawChatMessages =
      <span class="splash-type">UserDefaults</span>.<span class="splash-property">standard</span>.<span class="splash-call">array</span>(forKey: <span class="splash-string">"chatMessages"</span>) <span class="splash-keyword">as</span>? [<span class="splash-type">RawChatMessage</span>] <span class="splash-keyword">else</span> { <span class="splash-keyword">return nil</span> }

  <span class="splash-keyword">let</span> yesterday = <span class="splash-type">Calendar</span>.<span class="splash-property">current</span>.<span class="splash-call">date</span>(byAdding: .<span class="splash-dotAccess">day</span>,
                                        value: -<span class="splash-number">1</span>,
                                        to: <span class="splash-type">Date</span>())!

    <span class="splash-keyword">return</span> rawChatMessages
        .<span class="splash-call">compactMap</span>(transformDictToChatMessage)
        .<span class="splash-call">filter</span> { $0.<span class="splash-property">creationDate</span> &gt; yesterday }
}
</code></pre><p>Even though this function gets the job done, we have a few problems. We've come across our first type of side effect. <code>UserDefaults.standard</code>, <code>Calendar.current</code> and <code>Date()</code> are all <strong>hidden inputs</strong>. <code>UserDefaults.standard</code> and <code>Calendar.current</code> are both singletons that can be altered by other parts of our program at any time. Also, since we only get the date at the time of invocation, this function will not produce predictable results if invoked multiple times, which reduces testability.</p><p>Let's see if we can restore predicability and remove outside influence to restore our ability to locally reason about this piece of code:</p><pre><code><span class="splash-keyword">func</span> getChatMessages(rawChatMessages: [<span class="splash-type">RawChatMessage</span>], filter: (<span class="splash-type">ChatMessage</span>) -&gt; <span class="splash-type">Bool</span>) -&gt; [<span class="splash-type">ChatMessage</span>] {
    <span class="splash-keyword">return</span> rawChatMessages
        .<span class="splash-call">compactMap</span>(transformDictToChatMessage)
        .<span class="splash-call">filter</span>(filter)
}

<span class="splash-comment">// Usage</span>
<span class="splash-keyword">let</span> yesterday = <span class="splash-type">Calendar</span>.<span class="splash-property">current</span>.<span class="splash-call">date</span>(byAdding: .<span class="splash-dotAccess">day</span>, value: -<span class="splash-number">1</span>, to: <span class="splash-type">Date</span>())!

<span class="splash-call">getChatMessages</span>(rawChatMessages: rawChatMessages,
                filter: { $0.<span class="splash-property">creationDate</span> &gt; yesterday })
</code></pre><p>In our above solution, we've leveraged dependency injection to remove <code>UserDefaults.standard</code> and <code>Calendar.current</code> from the equation altogether. Our function no longer cares about these concepts, which makes tests much easier to write. We've also added the <code>filter</code> parameter. Now a date can be injected. This will allow us to get predictable results when the function is invoked multiple times as the date will not change during each invocation.</p><p>Now that we have a clean way to retrieve chat messages, what about saving new ones? Let's start by taking the following approach:</p><pre><code><span class="splash-keyword">func</span> saveChatMessages(<span class="splash-keyword">_</span> chatMessages: [<span class="splash-type">ChatMessage</span>]) {
    chatMessages.<span class="splash-call">forEach</span> {
        <span class="splash-type">AnalyticsManager</span>.<span class="splash-property">shared</span>.<span class="splash-call">recordChatMessage</span>($0)
    }

    <span class="splash-keyword">let</span> rawChatMessages = chatMessages.<span class="splash-call">map</span>(transformChatMessageToDict)
    <span class="splash-type">UserDefaults</span>.<span class="splash-property">standard</span>.<span class="splash-call">set</span>(rawChatMessages, forKey: <span class="splash-string">"chatMessages"</span>)
}
</code></pre><p>So, here we have an <code>AnalyticsManager</code> recording some information. Maybe we're interested in tracking which of our users are the most active or which topics users are discussing on a given day. We're also persisting our chat messages to user defaults.</p><p>There's a lot going on here. Both <code>AnalyticsManager</code> and <code>UserDefaults</code> are reaching out to the outside world and making some sort of change. They are both examples of <strong>hidden outputs</strong>. Testing this function is going to take a bit of work. We can do better by breaking things apart.</p><pre><code><span class="splash-keyword">typealias</span> ProcessMessage = (<span class="splash-type">ChatMessage</span>) -&gt; <span class="splash-type">Void</span>

<span class="splash-keyword">func</span> saveChatMessages(<span class="splash-keyword">_</span> chatMessages: [<span class="splash-type">ChatMessage</span>], processMessage: <span class="splash-type">ProcessMessage</span>?) -&gt; [<span class="splash-type">RawChatMessage</span>] {
    <span class="splash-keyword">if let</span> processMessage = processMessage {
        chatMessages.<span class="splash-call">forEach</span>(processMessage)
    }

    <span class="splash-keyword">return</span> chatMessages.<span class="splash-call">map</span>(transformChatMessageToDict)
}
</code></pre><p>In this incarnation of our function, <code>AnalyticsManager</code> and <code>UserDefaults</code> are nowhere to be found so our tests don't have to worry about them. But we can still use both these classes in our app code. <code>AnalyticsManager</code> can be injected via the <code>processMessage</code> closure that can be optionally provided as a function parameter and we can process the raw chat messages and save them to <code>UserDefaults</code> by using the array returned by the function.</p><p>Side effects are quite common in many codebases. Our goal should always be to define a clear API and ensure that testing is not cumbersome. This is easier to do if we limit the side effects in our code. Introducing stronger forms of decoupling and ensuring that our functions are following the principal of <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility</a> can go a long way in limiting the amount of side effects we have to live with.</p><p>Have you come across other types of side effects in your code? If so, let me know on Twitter <a href="https://twitter.com/siddarthkalra">@siddarthkalra</a>. All other forms of feedback are welcome as well. Have a great day and props to you for reading till the end!</p>]]></content:encoded></item><item><guid isPermaLink="true">https://siddarthkalra.github.io/articles/2019-03-15-collection-of-keypaths</guid><title>A collection of key paths, same root type but different values</title><description>I love Swift KeyPaths as they allow us to work in a type-safe environment. But I ran into a problem the other day when using them for a feature I was implementing.</description><link>https://siddarthkalra.github.io/articles/2019-03-15-collection-of-keypaths</link><pubDate>Fri, 15 Mar 2019 10:18:00 -0400</pubDate><content:encoded><![CDATA[<h1>A collection of key paths, same root type but different values</h1><p>I love Swift <a href="https://developer.apple.com/documentation/swift/keypath"><code>KeyPaths</code></a> as they allow us to work in a type-safe environment. But I ran into a problem the other day when using them for a feature I was implementing.</p><p>I wanted the ability to create an array of <code>KeyPaths</code> where the <code>Root</code> was the same type but the <code>Value</code> types were different. The first thing I tried was this:</p><pre><code><span class="splash-keyword">class</span> Dog {
    <span class="splash-keyword">@objc let</span> name: <span class="splash-type">String</span> = <span class="splash-string">""</span>
    <span class="splash-keyword">@objc let</span> age: <span class="splash-type">Int</span> = <span class="splash-number">0</span>
}

<span class="splash-keyword">let</span> keyPaths = [\<span class="splash-type">Dog</span>.<span class="splash-property">name</span>, \<span class="splash-type">Dog</span>.<span class="splash-property">age</span>]
</code></pre><p>Xcode reports that <code>keyPaths</code> has the type <code>PartialKeyPath&lt;Dog&gt;</code>. This actually makes sense because <code>name</code> is a <code>String</code> while <code>age</code> is an <code>Int</code>. So, Swift uses a <a href="https://developer.apple.com/documentation/swift/partialkeypath"><code>PartialKeyPath</code></a>, which type-erases the <code>Values</code> for you.</p><p>This was great but didn't work for my particular problem. I wanted to use <code>KeyPaths</code> to represent property names in a type-safe manner. Given a <code>KeyPath</code>, print out the property name of the value, like so:</p><pre><code><span class="splash-keyword">func</span> printPropertyName&lt;Root, Value&gt;(keyPath: <span class="splash-type">KeyPath</span>&lt;<span class="splash-type">Root</span>, <span class="splash-type">Value</span>&gt;) {
    <span class="splash-keyword">let</span> propertyName = <span class="splash-type">NSExpression</span>(forKeyPath: keyPath).<span class="splash-property">keyPath</span>
    <span class="splash-call">print</span>(propertyName)
}

<span class="splash-call">printPropertyName</span>(keyPath: \<span class="splash-type">Dog</span>.<span class="splash-property">name</span>) <span class="splash-comment">// prints name</span>
<span class="splash-call">printPropertyName</span>(keyPath: \<span class="splash-type">Dog</span>.<span class="splash-property">age</span>) <span class="splash-comment">// prints age</span>
</code></pre><p><code>NSExpression</code> is a great Apple API that gives us the ability to retrieve the property name of a <code>KeyPath</code>, if the property is annotated with <code>@objc</code>.</p><p>Next, I wanted the ability to pass in a collection of <code>KeyPaths</code> like so:</p><pre><code><span class="splash-call">printPropertyNames</span>(keyPaths: [\<span class="splash-type">Dog</span>.<span class="splash-property">name</span>, \<span class="splash-type">Dog</span>.<span class="splash-property">age</span>])
</code></pre><p>As we saw earlier, the type of the array would be <code>PartialKeyPath&lt;Dog&gt;</code>. Unfortunately, since the <code>KeyPath's</code> <code>Value</code> is type-erased, we loose the ability to retrieve the property names and <code>NSExpression()</code> no longer works for us.</p><pre><code><span class="splash-keyword">func</span> printPropertyNames&lt;Root&gt;(keyPaths: [<span class="splash-type">PartialKeyPath</span>&lt;<span class="splash-type">Root</span>&gt;]) {
    keyPaths.<span class="splash-call">forEach</span> { keyPath <span class="splash-keyword">in
        let</span> valueName = <span class="splash-type">NSExpression</span>(forKeyPath: keyPath).<span class="splash-property">keyPath</span>
        <span class="splash-call">print</span>(valueName)
    }
}

<span class="splash-call">printPropertyNames</span>(keyPaths: [\<span class="splash-type">Dog</span>.<span class="splash-property">name</span>, \<span class="splash-type">Dog</span>.<span class="splash-property">age</span>])
</code></pre><p>The compiler tells us we're crazy by throwing an error <code>Cannot invoke initializer for type 'NSExpression' with an argument list of type '(forKeyPath: (PartialKeyPath&lt;Root&gt;))'</code> for the code shown above.</p><p>So, how do we get around this problem? Well, one approach is to wrap our <code>KeyPath</code> access in a closure.</p><p>Let's start by defining a function that makes this wrapping closure for us. We'll refer to the closure as a <code>PropertyRef</code>:</p><pre><code><span class="splash-keyword">typealias</span> PropertyName = <span class="splash-type">String</span>

<span class="splash-keyword">func</span> makePropertyRef&lt;Root, Value&gt;(keyPath: <span class="splash-type">KeyPath</span>&lt;<span class="splash-type">Root</span>, <span class="splash-type">Value</span>&gt;) -&gt; (<span class="splash-type">Root</span>.<span class="splash-type">Type</span>) -&gt; <span class="splash-type">PropertyName</span> {
    <span class="splash-keyword">return</span> { rootType <span class="splash-keyword">in
        let</span> propertyName = <span class="splash-type">NSExpression</span>(forKeyPath: keyPath).<span class="splash-property">keyPath</span>
        <span class="splash-keyword">return</span> propertyName
    }
}
</code></pre><p>Now, given a <code>KeyPath</code>, we can make a <code>PropertyRef</code>. All that remains is to rewrite our print property name function to work with <code>PropertyRefs</code> instead of <code>KeyPaths</code>:</p><pre><code><span class="splash-keyword">func</span> printPropertyNames&lt;Root&gt;(propertyRefs: (<span class="splash-type">Root</span>.<span class="splash-type">Type</span>) -&gt; <span class="splash-type">PropertyName</span>...) {
    <span class="splash-keyword">let</span> propertyNames = propertyRefs.<span class="splash-call">map</span> { $0(<span class="splash-type">Root</span>.<span class="splash-keyword">self</span>) }
    <span class="splash-call">print</span>(propertyNames)
}

<span class="splash-call">printPropertyNames</span>(propertyRefs: <span class="splash-call">makePropertyRef</span>(keyPath: \<span class="splash-type">Dog</span>.<span class="splash-property">name</span>), <span class="splash-call">makePropertyRef</span>(keyPath: \<span class="splash-type">Dog</span>.<span class="splash-property">age</span>))
</code></pre><p>This is great because we retain the type-safety that KeyPaths give us and it stops us from mixing <code>Root</code> types, which is exactly what we want.</p><pre><code><span class="splash-call">printPropertyNames</span>(propertyRefs: <span class="splash-call">makePropertyRef</span>(keyPath: \<span class="splash-type">Dog</span>.<span class="splash-property">breed</span>)) <span class="splash-comment">// compiler error</span>
<span class="splash-call">printPropertyNames</span>(propertyRefs: <span class="splash-call">makePropertyRef</span>(keyPath: \<span class="splash-type">Dog</span>.<span class="splash-property">name</span>), <span class="splash-call">makePropertyRef</span>(keyPath: \<span class="splash-type">Cat</span>.<span class="splash-property">age</span>)) <span class="splash-comment">// compiler error</span>
</code></pre><p>So, there you have it. We now have the ability to produce a collection of <code>KeyPaths</code> where our <code>Root</code> is the same but the values are different while retaining our ability to access the property names of the <code>Values</code>.</p>]]></content:encoded></item></channel></rss>