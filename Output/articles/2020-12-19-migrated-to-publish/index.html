<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="An Unheralded Perspective"/><link rel="canonical" href="https://siddarthkalra.github.io/articles/2020-12-19-migrated-to-publish"/><meta name="twitter:url" content="https://siddarthkalra.github.io/articles/2020-12-19-migrated-to-publish"/><meta name="og:url" content="https://siddarthkalra.github.io/articles/2020-12-19-migrated-to-publish"/><title>Migrating to Publish | An Unheralded Perspective</title><meta name="twitter:title" content="Migrating to Publish | An Unheralded Perspective"/><meta name="og:title" content="Migrating to Publish | An Unheralded Perspective"/><meta name="description" content="TBD"/><meta name="twitter:description" content="TBD"/><meta name="og:description" content="TBD"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to An Unheralded Perspective"/></head><body class="item-page"><header><div class="wrapper"><a class="site-name" href="/">An Unheralded Perspective</a><nav><ul><li><a class="selected" href="/articles">Articles</a></li><li><a href="/about">About</a></li></ul></nav></div></header><div class="wrapper"><article><div class="content"><h1>Migrating to Publish</h1><p>Today, I'm so glad to share that this website has been migrated to John Sundell's static site generator called <a href="https://github.com/JohnSundell/Publish">Publish</a>! ðŸŽ‰</p><p>I don't know the numbers but I'm almost giddy to join the <a href="https://news.ycombinator.com/item?id=21916803">growing number</a> of static websites that are moving away from Ruby based tools. I want to take this opportunity to document some learnings and future enhancements.</p><h2>Getting setup</h2><p>I love working in <a href="https://swift.org/">Swift</a> so this was a no-brainer for me. This website is hosted on <a href="https://pages.github.com/">GitHub Pages</a> and previously you were almost forced to adopt something like <a href="https://jekyllrb.com/">Jekyll</a>, a static site generator written in Ruby. Well, those days are over! So how easy was it to migrate this incredibly small website to Publish?</p><p>If you have previous Swift knowledge, this will be a breeze to setup. I want to give kudos to John Sundell for designing such a simple API that is simultaneously extensible.</p><p>So lets go through the minimum amount of steps you need to complete in order to generate your fancy new website.</p><h3>1. Define your fancy new website</h3><p>This is done by conforming to the <code>Website</code> protocol.</p><pre><code><span class="splash-keyword">struct</span> FancyNewSite: <span class="splash-type">Website</span> {
    <span class="splash-keyword">enum</span> SectionID: <span class="splash-type">String</span>, <span class="splash-type">WebsiteSectionID</span> {
        <span class="splash-comment">// Add the sections that you want your website to contain here:</span>
        <span class="splash-keyword">case</span> posts
        <span class="splash-keyword">case</span> about
    }

    <span class="splash-keyword">struct</span> ItemMetadata: <span class="splash-type">WebsiteItemMetadata</span> {
        <span class="splash-comment">// Add any site-specific metadata that you want to use here.</span>
    }

    <span class="splash-comment">// Update these properties to configure your website:</span>
    <span class="splash-keyword">var</span> url = <span class="splash-type">URL</span>(string: <span class="splash-string">"https://fancynewsite.github.io"</span>)!
    <span class="splash-keyword">var</span> name = <span class="splash-string">"A Fancy New Site"</span>
    <span class="splash-keyword">var</span> description = <span class="splash-string">"Let's get fancy, shall we?"</span>
    <span class="splash-keyword">var</span> language: <span class="splash-type">Language</span> { .<span class="splash-dotAccess">english</span> }
    <span class="splash-keyword">var</span> imagePath: <span class="splash-type">Path</span>? { <span class="splash-keyword">nil</span> }
}
</code></pre><h3>2. Create a fancy theme</h3><p>This is how your website's HTML and CSS will be generated.</p><pre><code><span class="splash-keyword">extension</span> <span class="splash-type">Theme</span> <span class="splash-keyword">where</span> <span class="splash-type">Site</span> == <span class="splash-type">FancyNewSite</span> {
    <span class="splash-keyword">static var</span> fancyTheme <span class="splash-type">Self</span> {
        <span class="splash-type">Theme</span>(htmlFactory: <span class="splash-type">FancyHTMLFactory</span>(), resourcePaths: [<span class="splash-string">"Resources/fancyTheme/styles.css"</span>])
    }
}
</code></pre><p><code>FancyHTMLFactory</code> conforms to the <code>HTMLFactory</code> protocol. This is the type that will generate your website's HTML. Implement all the required methods and your site will be up and running in no time. Publish includes a default <code>foundation</code> theme that you can use as a reference.</p><h3>3. Define your fancy publishing pipeline</h3><p>There's two ways you can go here. We can get all fancy (pun intended) and use a custom pipeline or go with the default one that is provided out-of-the-box. I went with the default one for now since that has the advantage of being much quicker to setup.</p><pre><code><span class="splash-comment">// a default pipeline that generates your fancy site and deploys it to GitHub Pages</span>
<span class="splash-keyword">try</span> <span class="splash-type">FancyNewSite</span>().<span class="splash-call">publish</span>(withTheme: .<span class="splash-dotAccess">fancyTheme</span>,
                          deployedUsing: .<span class="splash-call">gitHub</span>(<span class="splash-string">"fancyNewSite/fancynewsite.github.io"</span>, useSSH: <span class="splash-keyword">true</span>)])
</code></pre><h3>4. Run locally then deploy</h3><p>Publish comes with a command line tool which provides the ability to run your website locally. Just execute the following in your terminal: <code>publish run -p 8000</code>.</p><p>Once you've iterated on your website locally it's time to share your hard work with the outside world. Again this is extremely simple - just run <code>publish deploy</code>.</p><p>That's it! You now have the excuse to get all fancy! ðŸ˜…</p><img src="https://media.giphy.com/media/c0BgDP4p4gO8E/giphy.gif" alt="Fancy GIF"/><h2>Issues encountered</h2><p>Alright putting all the fanciness aside, let's talk about some of the issues I encountered along the way.</p><h3>Local HTTP server blocks ports</h3><p>Every now and again the HTTP server can develop a glitch and stop working. You'll get a message indicating the port you're trying to use is already taken. Not sure how this ends up happening but it can get a bit annoying as you're forced to choose a different port each time. I tried killing any Python process that was running on my machine but unfortunately that didn't remedy the problem.</p><p>However, really this just ended up being a problem with my original workflow. Every time I would regenerate my site, I would just restart the server thus increasing the likelihood of running into this problem. A better approach is to keep the HTTP server running and just use another shell to execute <code>publish generate</code> to regenerate your website without having to constantly restart your server.</p><h3>Swift Package Manager</h3><p>Publish is just a <a href="https://swift.org/package-manager/">Swift package</a> and so is the website project that gets generated after you run <code>publish new</code>. I have experience with other dependency managers like <a href="https://github.com/Carthage/Carthage">Carthage</a>, <a href="https://cocoapods.org/">CocoaPods</a> and even <a href="https://www.npmjs.com/">NPM</a> but I'm pretty new to Swift Package Manager (SPM) myself.</p><p>In order to add Swift syntax highlighting to my posts, I decided to adopt John Sundell's <a href="https://github.com/JohnSundell/SplashPublishPlugin">Publish plugin for Splash</a>. However, adding <code>SplashPublishPlugin</code> as a dependency in my website's Package.swift, broke my build. I couldn't generate my website anymore as Xcode would no longer detect that my website had any active targets.</p><img src="https://media.giphy.com/media/3oKIPsU8OC7JhkvY8U/giphy.gif" alt="I'm stuck GIF"/><p>I was stumped. I had no idea how Xcode got into this state. So, I went for a swim in the world of SPM by reading Apple's <a href="https://swift.org/package-manager/">official docs</a> and even Sundell's <a href="https://www.swiftbysundell.com/articles/managing-dependencies-using-the-swift-package-manager/">article</a> on the subject. But I couldn't solve the problem.</p><p>My intuition indicated that I somehow needed to reset my build and throw out any existing build artifacts to have a "fresh start". I just didn't know how to do that. Ultimately, spending a bit of time snooping around Xcode revealed the solution.</p><pre><code class="language-no-highlight">File Ëƒ Swift Packages Ëƒ Reset Package Caches
</code></pre><p>This forces Xcode to regenerate your entire Package dependency chain. Once I chose this option all my problems were solved and I could generate my website once again. I was back on track.</p><h3>Section vs. Page</h3><p><code>Section</code> essentially models a directory with a rigid hierarchy. <code>Item</code> models each page within this directory and a given <code>Section</code> can contain many items.</p><p><code>Page</code>, on the other hand, models a standalone HTML page and doesn't hold any pre-conceived notions around directory hierarchy.</p><p>Use <code>Section</code> when you want to group a set of pages together. If something is standalone then use <code>Page</code> instead.</p><h3>WebsiteItemMetadata</h3><p><code>WebsiteItemMetadata</code> is a protocol that basically gives you the ability to include custom metadata for each <code>Item</code> defined by your website. Publish takes advantage of the Swift's type system and allows us to work with a strongly typed struct instead of using something like a dictionary, which cannot provide the same guarantees at compile-time.</p><p>Let's go through an example to solidify our understanding. Say I want to add a timestamp that indicates the last time each post on my website was edited. Posts on my website are embedded within a <code>Section</code> called <code>posts</code> and thus each post is an <code>Item</code>.</p><p>All I have to do now is to add the following to my metadata struct:</p><pre><code><span class="splash-keyword">struct</span> ItemMetadata: <span class="splash-type">WebsiteItemMetadata</span> {
    <span class="splash-keyword">var</span> lastEdited: <span class="splash-type">Date</span>
}
</code></pre><p>Now I can go through each one of my posts written in markdown and add this information within the --- lines at the top.</p><pre><code class="language-no-highlight">---
lastEdited: 2020-10-21 16:49
---
</code></pre><p>Lastly, I can simply access this new property in Swift via <code>item.lastEdited</code>. If somehow you don't update each post, Publish will throw an error when you try to generate your website:</p><pre><code class="language-no-highlight">Fatal error: Error raised at top level: Publish encountered an error:
[step] Add Markdown files from 'Content' folder
[path] posts/fancy-new-post.md
[info] Missing metadata value for key 'lastEdited'
</code></pre><p>Consider a website with hundred of posts. It would be easy to make mistakes and miss updating a post here or there. This type of rigid enforcement at generation time prevents such mistakes and doesn't let you move forward with publishing until you fix them. I think that's incredibly useful.</p><h3>Diffing the generated HTML</h3><p>The really nice part of Publish is that, if you commit your Output directory to Git, you can track exactly how your website's HTML has changed every time you regenerate it. This is a really nice way to catch regressions. The only issue is that the generated HTML is minified so understanding the diff becomes next to impossible.</p><p>If only there was a way to prevent this minification while your developing? ðŸ¤”Maybe there is but I haven't found it yet. I'll keep digging and report back if I find something!</p><h3>Deploying to GitHub Pages</h3><p>GitHub pages expects the content of your website to be situated in the root directory of your repository. However, by default, Publish will situate your generated website in <code>Output/</code>. Brian Coyner's <a href="https://briancoyner.github.io/articles/2020-02-25-cocoaheads_publish_notes/">article</a> on Publish came up with a great solution that I've adopted. The gist of the solution is as follows:</p><ul><li>Create a new branch called <code>author</code> or whatever suits your fancy</li><li>Push this branch to remote and make this your base branch on GitHub so that all new PRs are opened against this branch by default</li><li><code>author</code> becomes your main branch where the code for your Publish website package lives</li><li><code>master</code> becomes your deployment branch which only holds your generated HTML &amp; CSS for your website</li><li>Instead of changing <code>master</code> directly, deploy new changes to <code>master</code> by using <code>publish deploy</code> (assuming that your publishing pipeline is already setup to deploy to GitHub)</li></ul><h2>Future enhancements</h2><p>Getting the initial version of my website up and running has been so much fun! However, there's at least a couple more things I have in mind that would really streamline my process:</p><ul><li>for every new post, add the ability to automatically cross-publish the post on Medium and submit a tweet</li><li>add the ability to work on drafts without publishing them to the website before they're ready</li><li>a custom 404 page</li><li>add support for multiple CSS files that get minified into one CSS file</li></ul><p>As I make progress on these enhancements, I hope to share updates. Thank you to all that stuck around till the end. All feedback is welcome, so please don't hesitate to reach out to me on <a href="https://twitter.com/siddarthkalra">Twitter</a>. Now let's go build some websites! ðŸš€</p></div><span>Tags: </span><ul class="tag-list"><li class="tag tag-f"><a href="/tags/sundell-publish">sundell publish</a></li><li class="tag tag-e"><a href="/tags/swift">swift</a></li></ul></article></div><footer><p>An Unheralded Perspective Â© 2020 â‹… All rights reserved</p><p>Built in Swift using <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a></p><p><a href="https://twitter.com/siddarthkalra" target="_blank">Twitter</a> | <a href="/feed.rss" target="_blank">RSS</a></p></footer></body></html>